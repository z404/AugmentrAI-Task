lst = ['Atomic force microscopy Bionanotechnology Biomanufacturing Membrane Separation Biofilms Scaffolds for tissue engineering Electrospinning',
 'Fatigue & fracture of advanced structural metals “Cold dwell” sensitivity in titanium alloys Crack initiation and growth mechanisms Role of environment on mechanical performance High temperature characterisation of ceramic matrix c',
 'Computational Materials',
 'Printing Coating Fluid Dynamics Rheology Sensors Printed Electronics Statistics Process Optimisation Manufacturing',
 'Computational modelling of ore heap leaching processes Centrifugal shape casting for TiAl blades in aerospace engines Metal-metal seal design Vertical axis wind and water turbine design Micro-blood pump design optimisation Macro-segregation of metals',
 'None',
 'None',
 'None',
 'None',
 'Computational Mechanics Computational Engineering Computational Structural Dynamics Discrete Element Modelling Lattice Boltzmann method Fluid–solid interaction High performance computing',
 'None',
 'None',
 'In-silico modelling Computational Mechanics Large strain dynamics Fluid-Structure Interaction Electro-Magneto-Acousto-Mechanics Finite Element/Volume Methods Meshless Methods Reduced Order Modelling',
 'Unstructured Mesh Generation Computational Fluid Dynamics Computational Electromagnetics Parallel Processing',
 'None',
 'Water treatment Desalination Novel membrane separation processes Membrane nanotechnology Application of atomic force microscopy (AFM) to chemical and process engineering',
 'None',
 'Synthetic and materials chemistry Advanced devices such as photovoltaics (solar cells) High temperature thermal chemistry Steel manufacturing and value-added products Surface chemistry and sorption processes Water treatment Manufacturing optimisation',
 'None',
 'X-ray microtomography Aerospace materials Characterisation Bioinspiration',
 'Simulation and modelling of semiconductor devices.',
 'Computational modelling Laboratory experimentation Coastal and estuarine hydrodynamics and morphodynamics Coastal flood risk Environmental impacts of marine renewables Nature-based coastal engineering Climate change impacts on the coastal environment',
 'Miniaturised Testing Additive Layer Manufacturing (ALM) processes Nickel Superalloys (single crystals, polycrystalline) Thermo-mechanical Fatigue Fatigue Lifing Failure Analysis Non-Destructive Evaluation Titanium Alloys',
 'Additive Layer Manufacturing High Throughput Materials Characterisation Novel Alloy Development Multi-physics coupled Computational Fluids Dynamics Finite Element Analysis Life cycle assessment computational modelling',
 'None',
 'None',
 'Computational Solid Mechanics and Computational Fluid Dynamics Physics-based Data Mining and Visual Computing Civil and Structural Engineering Geo-mechanics, Oil & Gas Reservoir Concrete, Composite, Heterogeneous and Porous Materials',
 'Microelectromechanical Systems Nanoelectromechanical Systems Sensors and Actuators Optical MEMs RF MEMS Biological/Medical Transducers Micro-batteries',
 'None',
 'None',
 'Marine energy Ocean energy Wave Tidal turbine',
 'None',
 'None',
 'None',
 'None',
 'None',
 'None',
 'Nanoscience and Nanotechnology Nanomaterials Nanoclusters and Nanoparticles Nanocatalysts, Nanosensors, Nanophotonics Neuromorphic Systems for Information Processing Surface Science including Atomic Manipulation Innovations in Instrumentation',       
 'Metallurgy Galvanising Metallic coatings Corrosion Stainless steel Zinc aluminium alloys External funding Industrial engagement  Doctoral training',
 'None',
 'Ferrous Process Metallurgy Raw Materials Processing Materials Characterisation Mechanical Metallurgy Refractory Materials',
 'None',
 'Coastal Flooding Erosion Coastal Engineering',
 'None',
 'Systems Cytometry Nanoparticle metrology and toxicology Nanoparticle fluorophores',
 'Nanoelectronics Nanomaterials Nanobiosensors Nanotechnology and Nanoscience Sensor Technologies Semiconductor Surface and Interface Scanning Probe Microscopy',
 'High Speed Aerodynamics  Computational Fluid Dynamics  Data Analysis Geoenvironmental Engineering Geotechnical Engineering Coupled Processes in the Ground Thermo/Hydraulic/Chemical/Mechanical/Biological Behaviour Numerical Modelling',
 'Thin Film Photovoltaics Deposition and Curing Scaling Electrochemical Characterisation Corrosion Dye-Sensitized Solar Cells Organolead Halide Perovskite Kesterite CZTS',
 'Thermo-mechanical Fatigue  Creep Lifing Titanium Alloys Nickel Alloys Crystallographic Texture Fatigue Lifing Fatigue/Creep/Environment Interactions',
 'Non-Newtonian Fluid Mechanics Rheology Haemorheology Rheometry Process Engineering Cavitation',
 'ACTIVE Buildings Coatings used for corrosion protection to renewable energy generation Solution processed perovskite solar cells Building integrated photovoltaics Coating applications and development Corrosion science and engineering ',
 'Carbon Capture and Utilisation Industrial Decarbonisation Low Carbon Energy CO2 Capture Materials CO2 Conversion Catalysis Materials Science & Engineering Chemistry & Electrochemistry Energy Transport Materials',
 'Electrocatalysis Biosensors Electrochemistry Thin films',
 'Stochastic Analysis Systems Biology Cytometry Evolutionary Computing Intelligent Large-Scale Data Analysis/Simulation Fractal Generation and Analysis',
 'None',
 'None',
 'Titanium alloys Nickel superalloys Nickel Manufacture Grain Boundary Engineering Semi-solid forming Additive Layer Manufacturing Metals Casting Failure Analysis (Metals)',
 'None',
 'Applied Photonics Optical Fibre Communication Sensor',
 'High speed aerodynamics Computational fluid dynamics Molecular gas dynamics Optimisation Engineering education and public engagement',
 'Creep life prediction Process optimisation Steel demand forecasting Data mining in manufacturing',
 'Manufacturing Systems Engineering Big Data Manufacturing Informatics and IoTs Machine Learning/Deep Learning Artificial Intelligence Process Optimisation',
 'Robotics and Automation Micro and Nano Fabrication Machine Design 3D Printing Medical Engineering Biomimetics',
 'None',
 'None',
 'None',
 'Power semiconductor device physics and design Wide bandgap materials and devices Electrical characterisation of power semiconductor devices Reliability of power semiconductor devices',
 'Printing and coating processes and materials Coating characterization Printed electronics scale manufacture Thermochemical heat storage',
 'None',
 'Functional Industrial Coatings Energy storage Water, sanitation and hygiene Rapid Radiative Curing and Sintering Instrumental and Analytical Techniques',
 'Zinc oxide nanostructures Surface science Gas sensing X-ray Photoelectron spectroscopy Cryo-electron microscopy',
 'Computational Nanoelectronics Quantum Transport Simulations of Nanotransistors',
 'Chemical and bio-process engineering Reactor design Separation processes Algal technologies Membrane processes Pollution control and remediation Circular economy and sustainability',
 'Biochemical Engineering Surface science and spectroscopy Development of novel methods for microplastic characterisation (e.g. micro-FTIR imaging) Biofilms, biofouling and biocorrosion',
 'None',
 'Manufacturing Analytics Process optimisation and machine learning Uncertainty Quantification Risk based thinking, FMEAs and Organisational knowledge management Gait Analysis and bipedal walking Fluid flow at nano-scale Computational Engineering',
 'None',
 'Computational Fluid Dynamics Urban Fluid Mechanics Fluid-Structure Interactions Large Eddy Simulation Airflow and Air Pollution Modelling Turbulence Modelling',
 'None',
 'Computational Engineering High-order Finite Elements Numerical Methods Reduced Order Modelling Computational Fluid Dynamics Computational Electromagnetics Computer Aided Design Mesh generation',
 'Construction Management Project Management Digital Engineering Practice Professional Development',
 'Water and Wastewater Treatment Ozone Advanced Oxidation Processes (AOPs) Emerging Contaminants Separation Processes Reactor Engineering Adsorption and Catalysis Analytical Chemistry Chromatography',
 'None',
 'None',
 'Fluid Structure Interaction Computational Modelling Development of Sustainable Construction Materials',
 'None',
 'Hydrology and Hydrological Modelling Hydrometeorological Modelling Flood Risk Management and Flood Modelling Weather Radar and Rainfall Nowcasting Climate Change Impact on Water Resources and Extremes GIS, Statistical and AI Modelling of Hydrometeorologica',
 'Material Chemistry Colloid Chemistry Polymer Nanoparticles Drug delivery',
 'None',
 'None',
 'Synthesis of metal oxide nanoparticles Fabrication of mesoporous and compact oxide layers 3rd Generation Photovoltaics Materials Characterisation Low-C processing of nano-colloids',
 'Geotechnical Engineering Soil Stabilisation Highway Design Site Surveying Sustainable Building Materials in Concrete and Soil Structures',        
 'None',
 'Nanotechnology Electrical and structural characterisation of low-dimensional materials  Metal oxide nanowires and nanosheets Characterisation of electrostatic manipulation of graphene ripples and deformation Scanning probe microscopy and modelling of SPM',
 'None',
 'Microscopy Scanning Electron Microscopy Electron Backscatter Diffraction Grain Boundary Engineering In-Situ Microstructural analysis Materials Characterization X-Ray CT',
 'Computational fluid dynamics Metal processing Renewable energy devices (wind and tidal) Drinking water quality',
 'Manufacturing Non-destructive testing Image-based modelling X-ray tomography Finite element analysis Thermal characterisation',
 'Rheometry Haemorheology Non-Newtonian Fluid Flow NMR Diffusometry Fractal Aggregation and Analysis Fluorescence Microscopy.', 'elastic and rheological properties Bio-adhesion, ligands and receptors Cell motility',
 'None',
 'Radio Frequency circuits Analogue circuit design Applications of microcontrollers',
 'None',
 'None',
 'Power Systems Power Electronics Micro/smart- grids Virtual Synchronous Machines Ancillary services in future power systems  Power quality  Energy Management Systems Generation and load forecast using Artificial Intelligence ',
 'None',
 'Soft, responsive, and smart materials 3D printing of soft materials Experimental mechanics Numerical methods for solid mechanics Modelling composite materials at finite strain Low carbon renewable energy',
 'Ceramic Matrix Composites Nickel Superalloys Titanium Alloys Additive Manufacturing Solid State Welding Processes Miniaturised Testing Failure Analysis',
 'None',
 'None',
 'Experimental Aerodynamics Wind Turbine Aerodynamics Flow Control 3D Flow Separation Wind Energy Building Aerodynamics Drag Reduction',
 'None',
 'Synthesis of carbon nanotubes Nanomaterials and application toward a secure global energy future Circular economy, chemical recycling & resource utilization Blockchain, energy distribution and the future of decentralized energy generation',
 'Microstructure and Texture Evolution Deformation Mechanisms Thermomechanical Processing Phase Transformation Structure/Property Relationship Light Metals (Ti and Mg) Nuclear Materials (GEN-III and GEN-IV) EBSD Crystal Plasticity Finite Element Modelling',
 'Computational fluid dynamics (CFD) of compressible flow, multiphase flow, and reacting flow. Supersonic combustion. Detonation. Combustion for advanced aerospace propulsion. Hydrogen energy applications such as pressurised releases  cryogenic hydrogen jets',
 'Computational Fluid Dynamics Wind Energy Blood flow modelling Haemorheology Haemolysis',
 'Plastics Extrusion Extrusion jointing strength Structural design of buried pipes Environmental performance of thermoplastic systems Engineering management Business Strategy',
 'Fluid Dynamics Blood Flow Simulation Mesh Generation Geophysics Acoustics',
 'Microneedles Minimally invasive sensors Continuous glucose monitoring (CGM) Continuous lactate monitoring (CLM) Interstitial therapeutic drug monitoring (iTDM)',
 'Structural dynamics Nonlinear vibration Morphing aircraft Composite structures Rotordynamics',
 'Chemical Engineering Catalytic Pyrolysis Biomass and Bioenergy',
 'Power quality, power system modeling and analysis, harmonic mitigation, renewable energy sources, energy storage. ',
 'Raman spectroscopy Organic solar cells Degradation studies Novel application of photovoltaics Advanced characterization of printable solar cells',
 'Satellite Systems Design Deployable Structures for Space Applications Systems Engineering Quality and Reliability Engineering Smart Materials (shape memory alloys) Project Management',
 'Mechanics of nanomaterials and nanocomposites Electromechanical coupling at the nanoscale Small scale effects on the nanostructures Biomechanics of cytoskeleton in cells Cell electromechanics and its biomedical applications',
 'Multi-Physics Modelling Non-Newtonian Flow Renewable Energy',
 'None',
 'None',
 'Civil, Structural, and Medical Engineering Computational Mechanics Multiscale Modelling Red Blood Cell Physiology Numerical Methods Mechanics of Materials',
 'None',
 'Arterial Flow Modelling Multiphysics & Multiscale Tissue Modelling Bio-heat Transfer',
 'Next Generation Galvanised Steel Alloys Localised Corrosion Electrochemistry  Metallic Coatings Corrosion Inhibitors Product Design Engineering', 
 'Rheology Microrheology Microfluidics Particle/cell focusing and separation  Microscale flow Polyelectrolytes Graphene Oxide',
 'Distributed Generation Microgrids Renewable Energy Sources Energy Management Droop control Stability analysis Photovoltaic Robotics',
 'Membrane technology Process Design Project Management',
 'Computational Modelling Fluid-Structure Interaction at Nano-Scale Renewable Energy High Speed Aerodynamics Computational Fluid Dynamics Data Analysis',
 'Finite element analysis Material characterisation (creep/fatigue) Optimisation Additive layer manufacturing (ALM)',
 'None',
 'Linear and Nonlinear Structural Dynamics Aeroelasticity Active control Linear and Nonlinear control methods Non-smooth systems',
 'Fibre reinforced polymer composites Nanocomposites 3D printing of composites Thermosets & Thermoplastics Recycling of thermoplastics Moisture absorption & Accelerated weathering Mechanical testing & Materials characterisation Finite element analysis',
 'Coupled modelling of hydro-sediment-morphodynamics processes Geohazards: Landslides, Debris flows, Barrier Lake formation and breach Flood risk management: Flash floods; Urban floods Numerical methods and high performance computing',
 'Design of MEMS/NEMS devices Nonlinear Structural Dynamics Vibration-based energy harvesters MEMS bio sensor Experimental studies and data analysis',
 'Practical training Operations Key skills for Engineers Aerospace Systems Aircraft Maintenance Project Planning Risk Assessment Lateral Thinking', 
 'None',
 'Fatigue Creep Strain gauging Residual stress Nanoindentation',
 'Nano and Micro Plastic detection and identification Salinity Gradient Systems (PRO, FO) Advanced Oxidation Processes Membrane Technologies PPCP detection and removal',
 'Mechanical Design 3D Modelling & Simulation Parameterisation and Optimisation',
 'Computational Fluid Dynamics Multi-physics simulations of complex industrial processes Gas Atomisation Optimisation',
 'Localised corrosion Atmospheric corrosion; filiform corrosion and cathodic delamination Galvanic corrosion Corrosion of Al alloys Metallic alloy coatings Organic coatings Corrosion inhibitors Corrosion of additively manufactured components',
 'Aircraft Design Helicopter and UAV Flight Dynamics Aircraft Flying and Handling Qualities Autonomous Systems Aircraft Safety Aerospace System Model-based optimisation Uncertainty Quantification',
 'Water Treatment Water Quality Bio-/Chemo-sensors Desalination Nanomaterials Environmental Technologies',
 'None',
 'In silico tissue engineering Cellular biomechanics & mechanobiology CAE for biomedical device R&D (e.g. tissue engineering scaffolds, bioreactors, microfluidic chips, etc.)']

from re import sub
import threading

import gensim.downloader as api
from gensim.utils import simple_preprocess
from gensim.corpora import Dictionary
from gensim.models import TfidfModel
from gensim.similarities import WordEmbeddingSimilarityIndex
from gensim.similarities import SparseTermSimilarityMatrix
from gensim.similarities import SoftCosineSimilarity
from gensim.models.keyedvectors import Word2VecKeyedVectors

# Import and download the most up-to-date stopwords from NLTK
# from nltk import download
# from nltk.corpus import stopwords
# download('stopwords')  # Download stopwords list.
# nltk_stop_words = set(stopwords.words("english"))

# Or use a hard-coded list of English stopwords
nltk_stop_words = {'a','about','above','after','again','against','ain','all','am','an','and','any','are','aren',"aren't",'as','at','be','because','been','before','being','below','between','both','but','by','can','couldn',"couldn't",'d','did','didn',"didn't",'do','does','doesn',"doesn't",'doing','don',"don't",'down','during','each','few','for','from','further','had','hadn',"hadn't",'has','hasn',"hasn't",'have','haven',"haven't",'having','he','her','here','hers','herself','him','himself','his','how','i','if','in','into','is','isn',"isn't",'it',"it's",'its','itself','just','ll','m','ma','me','mightn',"mightn't",'more','most','mustn',"mustn't",'my','myself','needn',"needn't",'no','nor','not','now','o','of','off','on','once','only','or','other','our','ours','ourselves','out','over','own','re','s','same','shan',"shan't",'she',"she's",'should',"should've",'shouldn',"shouldn't",'so','some','such','t','than','that',"that'll",'the','their','theirs','them','themselves','then','there','these','they','this','those','through','to','too','under','until','up','ve','very','was','wasn',"wasn't",'we','were','weren',"weren't",'what','when','where','which','while','who','whom','why','will','with','won',"won't",'wouldn',"wouldn't",'y','you',"you'd","you'll","you're","you've",'your','yours','yourself','yourselves'}


class NotReadyError(Exception):
    pass


class DocSim:
    """
    Find documents that are similar to a query string.
    Calculated using word similarity (Soft Cosine Similarity) of word embedding vectors
    Example usage:
    # Use default model (glove-wiki-gigaword-50)
    docsim = DocSim()
    docsim.similarity_query(query_string, documents)
    # Or, specify a preferred, pre-existing Gensim model with custom stopwords and verbose mode    
    docsim = DocSim(model='glove-twitter-25', stopwords=['the', 'and', 'are'], verbose=True)
    docsim.similarity_query(query_string, documents)
    # Or, supply a custom pre-initialised model in gensim.models.keyedvectors.Word2VecKeyedVectors format
    docsim = DocSim(model=myModel)
    docsim.similarity_query(query_string, documents)    
    """

    default_model = "glove-wiki-gigaword-50"
    model_ready = False  # Only really relevant to threaded sub-class
    
    def __init__(self, model=None, stopwords=None, verbose=False):
        # Constructor

        self.verbose = verbose

        self._load_model(model)

        if stopwords is None:
            self.stopwords = nltk_stop_words
        else:
            self.stopwords = stopwords

    def _load_model(self, model):
        # Pass through to _setup_model (overridden in threaded)
        self._setup_model(model)

    def _setup_model(self, model):
        # Determine which model to use, download/load it, and create the similarity_index
        
        if isinstance(model, Word2VecKeyedVectors):
            # Use supplied model
            self.model = model
        elif isinstance(model, str):
            # Try to download named model
            if self.verbose: 
                print(f'Loading word vector model: {model}')
            self.model = api.load(model)
            if self.verbose: 
                print('Model loaded')
        elif model is None:
            # Download/use default GloVe model
            if self.verbose: 
                print(f'Loading default GloVe word vector model: {self.default_model}')
            self.model = api.load(self.default_model)
            if self.verbose: 
                print('Model loaded')
        else:
            raise ValueError('Unable to load word vector model')

        self.similarity_index = WordEmbeddingSimilarityIndex(self.model)
        
        self.model_ready = True

    def preprocess(self, doc: str):
        # Clean up input document string, remove stopwords, and tokenize
        doc = sub(r'<img[^<>]+(>|$)', " image_token ", doc)
        doc = sub(r'<[^<>]+(>|$)', " ", doc)
        doc = sub(r'\[img_assist[^]]*?\]', " ", doc)
        doc = sub(r'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+', " url_token ", doc)
        
        return [token for token in simple_preprocess(doc, min_len=0, max_len=float("inf")) if token not in self.stopwords]

    def _softcossim(self, query: str, documents: list):
        # Compute Soft Cosine Measure between the query and each of the documents.
        query = self.tfidf[self.dictionary.doc2bow(query)]
        index = SoftCosineSimilarity(
            self.tfidf[[self.dictionary.doc2bow(document) for document in documents]],
            self.similarity_matrix)
        similarities = index[query]

        return similarities

    def similarity_query(self, query_string: str, documents: list):
        """
        Run a new similarity ranking, for query_string against each of the documents
        Arguments:
            query_string: (string)
            documents: (list) of string documents to compare query_string against
            explain: (bbol) if True, highest scoring words are also returned
        Returns:
            list: similarity scores for each of the documents
            or
            NotReadyError: if model is not ready/available
        """

        if self.model_ready:
        
            corpus = [self.preprocess(document) for document in documents]
            query = self.preprocess(query_string)

            if set(query) == set([word for document in corpus for word in document]):
                raise ValueError('query_string full overlaps content of document corpus')
            
            if self.verbose:
                print(f'{len(corpus)} documents loaded into corpus')
            
            self.dictionary = Dictionary(corpus+[query])
            self.tfidf = TfidfModel(dictionary=self.dictionary)
            self.similarity_matrix = SparseTermSimilarityMatrix(self.similarity_index, 
                                                self.dictionary, self.tfidf)
                        
            scores = self._softcossim(query, corpus)

            return scores.tolist()

        else:
            raise NotReadyError('Word embedding model is not ready.')


class DocSim_threaded(DocSim):
    """
    Threaded verion to load model (long running process) in background. Everything else same as standard version.
    Find documents that are similar to a query string.
    Calculated using word similarity (Soft Cosine Similarity) of word embedding vectors
    Example usage:
    docsim = DocSim_threaded()
    docsim.similarity_query(query_string, documents)
    """

    def _load_model(self, model):
        """
        # Setup the model in a separate thread
        """

        self.thread = threading.Thread(target=self._setup_model, args=[model])
        self.thread.setDaemon(True)
        self.thread.start()

# lst = filter(lambda x: x != "None", lst)

docsim = DocSim(verbose=True)
sim = docsim.similarity_query('metallurgy', lst)
print(sim)
print("----------------------")
sim = docsim.similarity_query('waves', lst)
print(sim)